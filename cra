#!/bin/bash

# CLI pour la plateforme CRA
# Utilisation: ./cra [commande] [options]

set -e

# Couleurs pour l'affichage
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Variables
ENV=${ENV:-dev}
COMPOSE_FILE="docker-compose.${ENV}.yml"

# Fonction d'aide
show_help() {
    cat << EOF
${BLUE}CLI CRA - Gestion Docker simplifiée${NC}

${GREEN}Usage:${NC}
  ./cra [commande] [options]

${GREEN}Commandes disponibles:${NC}

  ${YELLOW}Gestion des services:${NC}
    up [ENV]              Démarrer tous les services (dev par défaut)
    up:seed               Démarrer tous les services en dev et seed la DB
    down [ENV]            Arrêter tous les services
    restart [ENV]         Redémarrer tous les services
    ps [ENV]              Lister les conteneurs en cours d'exécution
    stop [ENV]            Arrêter les services sans supprimer les conteneurs
    start [ENV]           Démarrer les services existants

  ${YELLOW}Services individuels:${NC}
    up:backend [ENV]      Démarrer uniquement le backend
    up:frontend [ENV]     Démarrer uniquement le frontend
    up:db [ENV]           Démarrer uniquement postgres
    up:redis [ENV]        Démarrer uniquement redis

  ${YELLOW}Logs:${NC}
    logs [service]        Voir les logs (all par défaut)
    logs:f [service]      Suivre les logs en temps réel

  ${YELLOW}Build & Deploy:${NC}
    build [ENV]           Rebuild tous les services
    build:backend [ENV]   Rebuild le backend
    build:frontend [ENV]  Rebuild le frontend
    rebuild [ENV]         Rebuild et redémarrer tous les services

  ${YELLOW}Base de données:${NC}
    db:migrate            Exécuter les migrations Prisma
    db:reset              Reset la base de données
    db:studio             Ouvrir Prisma Studio
    db:seed               Seed la base de données
    db:shell              Ouvrir un shell PostgreSQL

  ${YELLOW}Utilitaires:${NC}
    exec [service] [cmd]  Exécuter une commande dans un conteneur
    shell [service]       Ouvrir un shell dans un conteneur
    clean                 Nettoyer les volumes et conteneurs
    clean:all             Nettoyer tout (volumes, images, conteneurs)
    health                Vérifier la santé des services

  ${YELLOW}Autres:${NC}
    env:dev               Utiliser l'environnement dev
    env:prod              Utiliser l'environnement prod
    help                  Afficher cette aide

${GREEN}Exemples:${NC}
  ./cra up                    # Démarrer en dev
  ./cra up:seed               # Démarrer en dev et seed la DB
  ./cra up prod               # Démarrer en prod
  ./cra logs backend          # Voir les logs du backend
  ./cra logs:f                # Suivre tous les logs
  ./cra exec backend npm test # Exécuter les tests du backend
  ./cra db:migrate            # Lancer les migrations
  ./cra clean                 # Nettoyer les volumes

${GREEN}Variables d'environnement:${NC}
  ENV=prod ./cra up           # Forcer l'environnement prod

EOF
}

# Fonction pour afficher le statut
print_status() {
    echo -e "${BLUE}>>> $1${NC}"
}

# Fonction pour afficher le succès
print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

# Fonction pour afficher une erreur
print_error() {
    echo -e "${RED}✗ $1${NC}"
}

# Fonction pour afficher un avertissement
print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Vérifier l'environnement
check_env() {
    local env=${1:-$ENV}
    if [ "$env" != "dev" ] && [ "$env" != "prod" ]; then
        print_error "Environnement invalide: $env (doit être 'dev' ou 'prod')"
        exit 1
    fi
    ENV=$env
    COMPOSE_FILE="docker-compose.${ENV}.yml"

    if [ ! -f "$COMPOSE_FILE" ]; then
        print_error "Fichier $COMPOSE_FILE non trouvé"
        exit 1
    fi
}

# Fonction principale
main() {
    local command=$1
    shift || true

    # Traiter les arguments
    local service_env=""
    if [ -n "$1" ] && ([ "$1" = "dev" ] || [ "$1" = "prod" ]); then
        service_env=$1
        shift || true
    fi

    check_env "$service_env"

    case $command in
        # Commandes de base
        up)
            print_status "Démarrage des services ($ENV)..."
            docker-compose -f $COMPOSE_FILE up -d "$@"
            print_success "Services démarrés"
            docker-compose -f $COMPOSE_FILE ps
            ;;

        up:seed)
            # Force dev environment
            ENV=dev
            COMPOSE_FILE="docker-compose.dev.yml"

            print_status "Démarrage des services en dev avec seeding..."
            docker-compose -f $COMPOSE_FILE up -d

            print_status "Attente que le backend soit prêt..."
            sleep 5

            # Attendre que le backend soit vraiment prêt
            local max_attempts=30
            local attempt=0
            while [ $attempt -lt $max_attempts ]; do
                if docker-compose -f $COMPOSE_FILE exec -T backend curl -f http://localhost:3001/health >/dev/null 2>&1; then
                    print_success "Backend prêt"
                    break
                fi
                attempt=$((attempt + 1))
                if [ $attempt -eq $max_attempts ]; then
                    print_warning "Le backend met du temps à démarrer, on continue quand même..."
                    break
                fi
                sleep 2
            done

            print_status "Exécution des migrations..."
            docker-compose -f $COMPOSE_FILE exec -T backend npx prisma migrate dev --skip-generate || print_warning "Migrations échouées ou déjà appliquées"

            print_status "Seeding de la base de données..."
            docker-compose -f $COMPOSE_FILE exec -T backend npx prisma db seed || docker-compose -f $COMPOSE_FILE exec -T backend npm run seed || print_warning "Seed échoué - vérifiez que le script de seed existe"

            print_success "Services démarrés et base de données seedée"
            docker-compose -f $COMPOSE_FILE ps
            ;;

        down)
            print_status "Arrêt des services ($ENV)..."
            docker-compose -f $COMPOSE_FILE down "$@"
            print_success "Services arrêtés"
            ;;

        restart)
            print_status "Redémarrage des services ($ENV)..."
            docker-compose -f $COMPOSE_FILE restart "$@"
            print_success "Services redémarrés"
            ;;

        ps)
            docker-compose -f $COMPOSE_FILE ps "$@"
            ;;

        stop)
            print_status "Arrêt des services ($ENV)..."
            docker-compose -f $COMPOSE_FILE stop "$@"
            print_success "Services arrêtés"
            ;;

        start)
            print_status "Démarrage des services ($ENV)..."
            docker-compose -f $COMPOSE_FILE start "$@"
            print_success "Services démarrés"
            ;;

        # Services individuels
        up:backend)
            print_status "Démarrage du backend ($ENV)..."
            docker-compose -f $COMPOSE_FILE up -d backend
            print_success "Backend démarré"
            ;;

        up:frontend)
            print_status "Démarrage du frontend ($ENV)..."
            docker-compose -f $COMPOSE_FILE up -d frontend
            print_success "Frontend démarré"
            ;;

        up:db)
            print_status "Démarrage de PostgreSQL ($ENV)..."
            docker-compose -f $COMPOSE_FILE up -d postgres
            print_success "PostgreSQL démarré"
            ;;

        up:redis)
            print_status "Démarrage de Redis ($ENV)..."
            docker-compose -f $COMPOSE_FILE up -d redis
            print_success "Redis démarré"
            ;;

        # Logs
        logs)
            local service=${1:-}
            if [ -z "$service" ] || [ "$service" = "all" ]; then
                docker-compose -f $COMPOSE_FILE logs --tail=100
            else
                docker-compose -f $COMPOSE_FILE logs --tail=100 "$service"
            fi
            ;;

        logs:f)
            local service=${1:-}
            if [ -z "$service" ] || [ "$service" = "all" ]; then
                docker-compose -f $COMPOSE_FILE logs -f
            else
                docker-compose -f $COMPOSE_FILE logs -f "$service"
            fi
            ;;

        # Build
        build)
            print_status "Build des images ($ENV)..."
            docker-compose -f $COMPOSE_FILE build "$@"
            print_success "Build terminé"
            ;;

        build:backend)
            print_status "Build du backend ($ENV)..."
            docker-compose -f $COMPOSE_FILE build backend
            print_success "Backend build terminé"
            ;;

        build:frontend)
            print_status "Build du frontend ($ENV)..."
            docker-compose -f $COMPOSE_FILE build frontend
            print_success "Frontend build terminé"
            ;;

        rebuild)
            print_status "Rebuild et redémarrage ($ENV)..."
            docker-compose -f $COMPOSE_FILE down
            docker-compose -f $COMPOSE_FILE build
            docker-compose -f $COMPOSE_FILE up -d
            print_success "Rebuild et redémarrage terminés"
            ;;

        # Base de données
        db:migrate)
            print_status "Exécution des migrations..."
            docker-compose -f $COMPOSE_FILE exec backend npx prisma migrate dev
            print_success "Migrations terminées"
            ;;

        db:reset)
            print_warning "Cette action va réinitialiser la base de données!"
            read -p "Êtes-vous sûr? (y/N) " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                docker-compose -f $COMPOSE_FILE exec backend npx prisma migrate reset
                print_success "Base de données réinitialisée"
            else
                print_status "Opération annulée"
            fi
            ;;

        db:studio)
            print_status "Ouverture de Prisma Studio..."
            docker-compose -f $COMPOSE_FILE exec backend npx prisma studio
            ;;

        db:seed)
            print_status "Seed de la base de données..."
            docker-compose -f $COMPOSE_FILE exec backend npx prisma db seed
            print_success "Seed terminé"
            ;;

        db:shell)
            print_status "Ouverture du shell PostgreSQL..."
            if [ "$ENV" = "dev" ]; then
                docker-compose -f $COMPOSE_FILE exec postgres psql -U postgres -d cra-db
            else
                docker-compose -f $COMPOSE_FILE exec postgres psql -U postgres -d cra-db
            fi
            ;;

        # Utilitaires
        exec)
            local service=$1
            shift || true
            if [ -z "$service" ]; then
                print_error "Service requis"
                exit 1
            fi
            docker-compose -f $COMPOSE_FILE exec $service "$@"
            ;;

        shell)
            local service=${1:-backend}
            print_status "Ouverture du shell dans $service..."
            docker-compose -f $COMPOSE_FILE exec $service sh
            ;;

        clean)
            print_warning "Nettoyage des volumes et conteneurs..."
            docker-compose -f $COMPOSE_FILE down -v
            print_success "Nettoyage terminé"
            ;;

        clean:all)
            print_warning "Nettoyage complet (volumes, images, conteneurs)..."
            read -p "Êtes-vous sûr? (y/N) " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                docker-compose -f $COMPOSE_FILE down -v --rmi all
                print_success "Nettoyage complet terminé"
            else
                print_status "Opération annulée"
            fi
            ;;

        health)
            print_status "Vérification de la santé des services..."
            docker-compose -f $COMPOSE_FILE ps
            echo ""
            print_status "Health checks:"
            docker-compose -f $COMPOSE_FILE exec -T backend curl -f http://localhost:3001/health 2>/dev/null && print_success "Backend: OK" || print_error "Backend: KO"
            ;;

        # Environnement
        env:dev)
            print_status "Basculement vers l'environnement dev"
            ENV=dev
            COMPOSE_FILE="docker-compose.dev.yml"
            ;;

        env:prod)
            print_status "Basculement vers l'environnement prod"
            ENV=prod
            COMPOSE_FILE="docker-compose.prod.yml"
            ;;

        # Aide
        help|--help|-h|"")
            show_help
            ;;

        *)
            print_error "Commande inconnue: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Exécuter la fonction principale
main "$@"
