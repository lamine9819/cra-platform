generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model StrategicPlan {
  id          String          @id @default(cuid())
  name        String          @unique
  description String?
  startYear   Int
  endYear     Int
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  axes        StrategicAxis[]

  @@map("strategic_plans")
}

model StrategicAxis {
  id              String             @id @default(cuid())
  name            String
  description     String?
  code            String?
  order           Int?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  strategicPlanId String
  strategicPlan   StrategicPlan      @relation(fields: [strategicPlanId], references: [id])
  subAxes         StrategicSubAxis[]

  @@unique([strategicPlanId, name])
  @@map("strategic_axes")
}

model StrategicSubAxis {
  id              String            @id @default(cuid())
  name            String
  description     String?
  code            String?
  order           Int?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  strategicAxisId String
  programs        ResearchProgram[]
  strategicAxis   StrategicAxis     @relation(fields: [strategicAxisId], references: [id])

  @@unique([strategicAxisId, name])
  @@map("strategic_sub_axes")
}

model ResearchProgram {
  id                 String           @id @default(cuid())
  name               String
  description        String?
  code               String?          @unique
  startDate          DateTime?
  endDate            DateTime?
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  strategicSubAxisId String
  coordinatorId      String
  projects           Project[]
  coordinator        User             @relation(fields: [coordinatorId], references: [id])
  strategicSubAxis   StrategicSubAxis @relation(fields: [strategicSubAxisId], references: [id])
  themes             ResearchTheme[]

  @@map("research_programs")
}

model ResearchTheme {
  id          String          @id @default(cuid())
  name        String
  description String?
  objectives  String[]
  code        String?         @unique
  order       Int?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  programId   String
  activities  Activity[]
  channels    Channel[]
  projects    Project[]
  program     ResearchProgram @relation(fields: [programId], references: [id])

  @@unique([programId, name])
  @@map("research_themes")
}

model ResearchStation {
  id          String          @id @default(cuid())
  name        String          @unique
  location    String
  surface     Float?
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  activities  Activity[]
  events      CalendarEvent[]

  @@map("research_stations")
}

model Convention {
  id                String            @id @default(cuid())
  title             String
  description       String?
  type              ConventionType
  status            ConventionStatus  @default(EN_NEGOCIATION)
  contractNumber    String?           @unique
  signatureDate     DateTime?
  startDate         DateTime?
  endDate           DateTime?
  totalBudget       Float?
  currency          String            @default("XOF")
  documentPath      String?
  mainPartner       String
  otherPartners     String[]
  responsibleUserId String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  activities        Activity[]
  activityFundings  ActivityFunding[]
  responsibleUser   User              @relation(fields: [responsibleUserId], references: [id])
  projectFundings   ProjectFunding[]
  projects          Project[]

  @@map("conventions")
}

model IndividualProfile {
  id                       String                     @id @default(cuid())
  matricule                String                     @unique
  grade                    String
  classe                   String?
  dateNaissance            DateTime
  dateRecrutement          DateTime
  localite                 String
  diplome                  String
  tempsRecherche           Int                        @default(0)
  tempsEnseignement        Int                        @default(0)
  tempsFormation           Int                        @default(0)
  tempsConsultation        Int                        @default(0)
  tempsGestionScientifique Int                        @default(0)
  tempsAdministration      Int                        @default(0)
  isValidated              Boolean                    @default(false)
  validatedAt              DateTime?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  userId                   String                     @unique
  user                     User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeAllocations          IndividualTimeAllocation[]

  @@map("individual_profiles")
}

model IndividualTimeAllocation {
  id                       String            @id @default(cuid())
  year                     Int
  tempsRecherche           Int               @default(0)
  tempsEnseignement        Int               @default(0)
  tempsFormation           Int               @default(0)
  tempsConsultation        Int               @default(0)
  tempsGestionScientifique Int               @default(0)
  tempsAdministration      Int               @default(0)
  isValidated              Boolean           @default(false)
  validatedAt              DateTime?
  validatedBy              String?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  profileId                String
  profile                  IndividualProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, year])
  @@map("individual_time_allocations")
}

model PersonnelRequest {
  id            String    @id @default(cuid())
  postType      String
  discipline    String
  profile       String
  diploma       String
  description   String
  competencies  String[]
  activities    String[]
  contractType  String
  location      String
  estimatedCost Float?
  fundingSource String?
  requestedDate DateTime?
  justification String
  status        String    @default("EN_ATTENTE")
  comments      String?
  decidedAt     DateTime?
  decidedBy     String?
  requestedById String
  center        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  requestedBy   User      @relation(fields: [requestedById], references: [id])

  @@map("personnel_requests")
}

model ScientificIndicator {
  id                       String    @id @default(cuid())
  year                     Int
  publicationsCount        Int       @default(0)
  articlesCount            Int       @default(0)
  conferencesCount         Int       @default(0)
  technicalReportsCount    Int       @default(0)
  projectsLeadCount        Int       @default(0)
  projectsParticipantCount Int       @default(0)
  totalFundingAmount       Float     @default(0)
  masterSupervisionsCount  Int       @default(0)
  phdSupervisionsCount     Int       @default(0)
  trainingsGivenCount      Int       @default(0)
  trainingsReceivedCount   Int       @default(0)
  knowledgeTransfersCount  Int       @default(0)
  demonstrationsCount      Int       @default(0)
  mediaAppearancesCount    Int       @default(0)
  partnershipsCount        Int       @default(0)
  internationalCollabCount Int       @default(0)
  calculatedAt             DateTime  @default(now())
  isValidated              Boolean   @default(false)
  validatedAt              DateTime?
  validatedBy              String?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  userId                   String
  user                     User      @relation(fields: [userId], references: [id])

  @@unique([userId, year])
  @@map("scientific_indicators")
}

model Publication {
  id               String              @id @default(cuid())
  title            String
  type             PublicationType
  journal          String?
  isbn             String?
  doi              String?
  url              String?
  volume           String?
  issue            String?
  pages            String?
  publisher        String?
  impactFactor     Float?
  quartile         String?
  citationsCount   Int                 @default(0)
  isOpenAccess     Boolean             @default(false)
  submissionDate   DateTime?
  acceptanceDate   DateTime?
  publicationDate  DateTime?
  status           String              @default("PUBLIE")
  isInternational  Boolean             @default(false)
  language         String              @default("fr")
  abstract         String?
  keywords         String[]
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  documentId       String?             @unique
  authors          PublicationAuthor[]
  document         Document?           @relation(fields: [documentId], references: [id])
  linkedActivities Activity[]          @relation("ActivityPublications")
  linkedProjects   Project[]           @relation("ProjectPublications")

  @@map("publications")
}

model PublicationAuthor {
  id              String      @id @default(cuid())
  authorOrder     Int
  isCorresponding Boolean     @default(false)
  affiliation     String?
  publicationId   String
  userId          String?
  externalName    String?
  externalEmail   String?
  createdAt       DateTime    @default(now())
  publication     Publication @relation(fields: [publicationId], references: [id], onDelete: Cascade)
  user            User?       @relation(fields: [userId], references: [id])

  @@map("publication_authors")
}

model ResearchObjective {
  id               String          @id @default(cuid())
  title            String
  description      String?
  category         String?
  startDate        DateTime?
  deadline         DateTime?
  status           ObjectiveStatus @default(EN_COURS)
  priority         TaskPriority    @default(NORMALE)
  progress         Int             @default(0)
  targetValue      Float?
  currentValue     Float?
  unit             String?
  notes            String?
  milestones       String[]
  completedAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  userId           String
  user             User            @relation(fields: [userId], references: [id])
  linkedActivities Activity[]      @relation("ActivityObjectives")
  linkedProjects   Project[]       @relation("ProjectObjectives")

  @@map("research_objectives")
}

model PerformanceEvaluation {
  id                     String    @id @default(cuid())
  year                   Int
  evaluationType         String
  researchScore          Float?
  publicationScore       Float?
  collaborationScore     Float?
  innovationScore        Float?
  transferScore          Float?
  leadershipScore        Float?
  strengths              String[]
  areasForImprovement    String[]
  evaluatorComments      String?
  selfAssessmentComments String?
  nextPeriodGoals        String[]
  isFinalized            Boolean   @default(false)
  finalizedAt            DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  evaluatedUserId        String
  evaluatorId            String?
  evaluatedUser          User      @relation("EvaluatedUser", fields: [evaluatedUserId], references: [id])
  evaluator              User?     @relation("Evaluator", fields: [evaluatorId], references: [id])

  @@unique([evaluatedUserId, year, evaluationType])
  @@map("performance_evaluations")
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  password               String
  firstName              String
  lastName               String
  role                   UserRole
  isActive               Boolean                 @default(true)
  profileImage           String?
  dateOfBirth            DateTime?
  dateOfHire             DateTime?
  phoneNumber            String?
  diploma                String?
  specialization         String?
  department             String?
  discipline             String?
  orcidId                String?
  researchGateId         String?
  googleScholarId        String?
  linkedinId             String?
  notificationPrefs      Json?
  dashboardConfig        Json?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  supervisorId           String?
  responsibleActivities  Activity[]              @relation("ActivityResponsible")
  activityParticipations ActivityParticipant[]
  auditLogs              AuditLog[]
  createdEvents          CalendarEvent[]         @relation("EventCreator")
  channelMemberships     ChannelMember[]
  createdChannels        Channel[]               @relation("ChannelCreator")
  chatMessages           ChatMessage[]           @relation("MessageAuthor")
  comments               Comment[]
  responsibleConventions Convention[]
  documentActivities     DocumentActivity[]
  documentShares         DocumentShare[]
  documents              Document[]
  eventParticipations    EventParticipant[]
  formResponses          FormResponse[]
  createdFormShares      FormShare[]             @relation("FormShareCreator")
  receivedFormShares     FormShare[]             @relation("FormShareReceiver")
  forms                  Form[]
  individualProfile      IndividualProfile?
  internships            Internship[]            @relation("InternshipIntern")
  supervisedInternships  Internship[]            @relation("InternshipSupervisor")
  knowledgeTransfers     KnowledgeTransfer[]
  messageMentions        MessageMention[]
  messageReactions       MessageReaction[]
  receivedNotifications  Notification[]          @relation("NotificationReceiver")
  sentNotifications      Notification[]          @relation("NotificationSender")
  evaluations            PerformanceEvaluation[] @relation("EvaluatedUser")
  conductedEvaluations   PerformanceEvaluation[] @relation("Evaluator")
  personnelRequests      PersonnelRequest[]
  projectParticipations  ProjectParticipant[]
  createdProjects        Project[]               @relation("ProjectCreator")
  publications           PublicationAuthor[]
  researchObjectives     ResearchObjective[]
  coordinatedPrograms    ResearchProgram[]
  scientificIndicators   ScientificIndicator[]
  seminarParticipations  SeminarParticipant[]
  organizedSeminars      Seminar[]               @relation("SeminarOrganizer")
  studentSupervisions    Supervision[]           @relation("SupervisionStudent")
  supervisedTheses       Supervision[]           @relation("SupervisionSupervisor")
  assignedTasks          Task[]                  @relation("TaskAssignee")
  createdTasks           Task[]                  @relation("TaskCreator")
  taskHistory            TaskHistory[]           @relation("TaskHistoryUser")
  trainingParticipations TrainingParticipant[]
  supervisor             User?                   @relation("UserSupervisor", fields: [supervisorId], references: [id])
  supervisedUsers        User[]                  @relation("UserSupervisor")

  @@map("users")
}

model Partner {
  id                   String            @id @default(cuid())
  name                 String
  type                 PartnerType
  category             String?
  description          String?
  address              String?
  phone                String?
  email                String?
  website              String?
  contactPerson        String?
  contactTitle         String?
  contactEmail         String?
  contactPhone         String?
  expertise            String[]
  services             String[]
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  activityPartnerships ActivityPartner[]
  projectPartnerships  ProjectPartner[]

  @@map("partners")
}

model Project {
  id                 String               @id @default(cuid())
  code               String               @unique
  title              String
  description        String?
  objectives         String[]
  status             ProjectStatus        @default(PLANIFIE)
  startDate          DateTime?
  endDate            DateTime?
  budget             Float?
  keywords           String[]
  strategicPlan      String?
  strategicAxis      String?
  subAxis            String?
  program            String?
  researchProgramId  String?
  conventionId       String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  creatorId          String
  themeId            String
  activities         Activity[]
  events             CalendarEvent[]
  channels           Channel[]
  comments           Comment[]
  documents          Document[]
  fundings           ProjectFunding[]
  participants       ProjectParticipant[]
  partnerships       ProjectPartner[]
  convention         Convention?          @relation(fields: [conventionId], references: [id])
  creator            User                 @relation("ProjectCreator", fields: [creatorId], references: [id])
  researchProgram    ResearchProgram?     @relation(fields: [researchProgramId], references: [id])
  theme              ResearchTheme        @relation(fields: [themeId], references: [id])
  tasks              Task[]
  researchObjectives ResearchObjective[]  @relation("ProjectObjectives")
  publications       Publication[]        @relation("ProjectPublications")

  @@map("projects")
}

model ProjectParticipant {
  id        String    @id @default(cuid())
  role      String
  joinedAt  DateTime  @default(now())
  leftAt    DateTime?
  isActive  Boolean   @default(true)
  projectId String
  userId    String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_participants")
}

model ProjectPartner {
  id           String    @id @default(cuid())
  partnerType  String
  contribution String?
  benefits     String?
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  projectId    String
  partnerId    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  partner      Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, partnerId])
  @@map("project_partners")
}

model ProjectFunding {
  id              String        @id @default(cuid())
  fundingSource   String
  fundingType     FundingType
  status          FundingStatus @default(DEMANDE)
  requestedAmount Float
  approvedAmount  Float?
  receivedAmount  Float?
  currency        String        @default("XOF")
  applicationDate DateTime?
  approvalDate    DateTime?
  startDate       DateTime?
  endDate         DateTime?
  conditions      String?
  contractNumber  String?
  notes           String?
  projectId       String
  conventionId    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  convention      Convention?   @relation(fields: [conventionId], references: [id])
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_fundings")
}

model Activity {
  id                 String                  @id @default(cuid())
  code               String?                 @unique
  title              String
  description        String?
  type               ActivityType            @default(RECHERCHE_EXPERIMENTALE)
  objectives         String[]
  methodology        String?
  location           String?
  startDate          DateTime?
  endDate            DateTime?
  results            String?
  conclusions        String?
  interventionRegion String?
  strategicPlan      String?
  strategicAxis      String?
  subAxis            String?
  lifecycleStatus    ActivityLifecycleStatus @default(NOUVELLE)
  researchType       String?
  status             ActivityStatus          @default(PLANIFIEE)
  priority           TaskPriority            @default(NORMALE)
  isRecurrent        Boolean                 @default(false)
  parentActivityId   String?
  recurrenceReason   String?
  recurrenceNotes    String?
  recurrenceCount    Int                     @default(0)
  originalStartDate  DateTime?
  justifications     String?
  constraints        String[]
  expectedResults    String[]
  transferMethods    String[]
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  projectId          String?
  themeId            String
  stationId          String?
  conventionId       String?
  responsibleId      String
  convention         Convention?             @relation(fields: [conventionId], references: [id])
  parentActivity     Activity?               @relation("ActivityRecurrence", fields: [parentActivityId], references: [id])
  childActivities    Activity[]              @relation("ActivityRecurrence")
  project            Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible        User                    @relation("ActivityResponsible", fields: [responsibleId], references: [id])
  station            ResearchStation?        @relation(fields: [stationId], references: [id])
  theme              ResearchTheme           @relation(fields: [themeId], references: [id])
  fundings           ActivityFunding[]
  participants       ActivityParticipant[]
  partnerships       ActivityPartner[]
  newRecurrences     ActivityRecurrence[]    @relation("NewRecurrence")
  sourceRecurrences  ActivityRecurrence[]    @relation("SourceRecurrence")
  events             CalendarEvent[]
  comments           Comment[]
  documents          Document[]
  forms              Form[]
  internships        Internship[]
  knowledgeTransfers KnowledgeTransfer[]
  supervisions       Supervision[]
  tasks              Task[]
  trainings          Training[]
  activityObjectives ResearchObjective[]     @relation("ActivityObjectives")
  publications       Publication[]           @relation("ActivityPublications")

  @@map("activities")
}

model ActivityParticipant {
  id               String          @id @default(cuid())
  role             ParticipantRole
  timeAllocation   Int?
  startDate        DateTime        @default(now())
  endDate          DateTime?
  isActive         Boolean         @default(true)
  responsibilities String?
  expertise        String?
  activityId       String
  userId           String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  activity         Activity        @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([activityId, userId])
  @@map("activity_participants")
}

model ActivityPartner {
  id           String    @id @default(cuid())
  partnerType  String
  contribution String?
  benefits     String?
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  activityId   String
  partnerId    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  activity     Activity  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  partner      Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([activityId, partnerId])
  @@map("activity_partners")
}

model ActivityFunding {
  id              String        @id @default(cuid())
  fundingSource   String
  fundingType     FundingType
  status          FundingStatus @default(DEMANDE)
  requestedAmount Float
  approvedAmount  Float?
  receivedAmount  Float?
  currency        String        @default("XOF")
  applicationDate DateTime?
  approvalDate    DateTime?
  startDate       DateTime?
  endDate         DateTime?
  conditions      String?
  reportingReqs   String[]
  restrictions    String[]
  contractNumber  String?
  contactPerson   String?
  contactEmail    String?
  notes           String?
  activityId      String
  conventionId    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  activity        Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  convention      Convention?   @relation(fields: [conventionId], references: [id])

  @@map("activity_fundings")
}

model ActivityRecurrence {
  id               String    @id @default(cuid())
  sourceActivityId String
  newActivityId    String
  recurrenceType   String
  reason           String?
  modifications    String[]
  budgetChanges    String?
  teamChanges      String?
  scopeChanges     String?
  decisionDate     DateTime  @default(now())
  approvalDate     DateTime?
  approvedBy       String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  newActivity      Activity  @relation("NewRecurrence", fields: [newActivityId], references: [id], onDelete: Cascade)
  sourceActivity   Activity  @relation("SourceRecurrence", fields: [sourceActivityId], references: [id], onDelete: Cascade)

  @@unique([sourceActivityId, newActivityId])
  @@map("activity_recurrences")
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(A_FAIRE)
  priority    TaskPriority @default(NORMALE)
  dueDate     DateTime?
  completedAt DateTime?
  progress    Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  creatorId   String
  assigneeId  String?
  projectId   String?
  activityId  String?
  comments    Comment[]
  documents   Document[]
  history     TaskHistory[]
  activity    Activity?    @relation(fields: [activityId], references: [id], onDelete: Cascade)
  assignee    User?        @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator     User         @relation("TaskCreator", fields: [creatorId], references: [id])
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model TaskHistory {
  id          String       @id @default(cuid())
  taskId      String
  userId      String
  field       String       // Le champ modifié (status, progress, title, etc.)
  oldValue    String?      // Ancienne valeur (JSON stringifié)
  newValue    String?      // Nouvelle valeur (JSON stringifié)
  action      String       // CREATE, UPDATE, DELETE
  createdAt   DateTime     @default(now())
  task        Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User         @relation("TaskHistoryUser", fields: [userId], references: [id])

  @@map("task_history")
  @@index([taskId])
  @@index([userId])
}

model Document {
  id                  String             @id @default(cuid())
  title               String
  filename            String
  filepath            String
  mimeType            String
  size                BigInt
  type                DocumentType
  description         String?
  tags                String[]
  isPublic            Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  ownerId             String
  projectId           String?
  activityId          String?
  taskId              String?
  seminarId           String?
  trainingId          String?
  internshipId        String?
  supervisionId       String?
  knowledgeTransferId String?
  eventId             String?
  deletedAt           DateTime?
  deletedBy           String?
  downloadCount       Int                @default(0)
  favoritedBy         String[]           @default([])
  lastViewedAt        DateTime?
  previousVersionId   String?
  version             Int                @default(1)
  viewCount           Int                @default(0)
  activities          DocumentActivity[]
  shares              DocumentShare[]
  activity            Activity?          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  event               CalendarEvent?     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  internship          Internship?        @relation(fields: [internshipId], references: [id], onDelete: Cascade)
  knowledgeTransfer   KnowledgeTransfer? @relation(fields: [knowledgeTransferId], references: [id], onDelete: Cascade)
  owner               User               @relation(fields: [ownerId], references: [id])
  project             Project?           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  seminar             Seminar?           @relation(fields: [seminarId], references: [id], onDelete: Cascade)
  supervision         Supervision?       @relation(fields: [supervisionId], references: [id], onDelete: Cascade)
  task                Task?              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  training            Training?          @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  publication         Publication?

  @@index([deletedAt])
  @@index([favoritedBy])
  @@map("documents")
}

model DocumentShare {
  id           String    @id @default(cuid())
  canEdit      Boolean   @default(false)
  canDelete    Boolean   @default(false)
  sharedAt     DateTime  @default(now())
  documentId   String
  sharedWithId String
  expiresAt    DateTime?
  revokedAt    DateTime?
  revokedBy    String?
  document     Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sharedWith   User      @relation(fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@unique([documentId, sharedWithId])
  @@index([revokedAt, expiresAt])
  @@map("document_shares")
}

model DocumentActivity {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  action     String
  metadata   Json?
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("document_activities")
}

model Form {
  id                       String         @id @default(cuid())
  title                    String
  description              String?
  schema                   Json
  isActive                 Boolean        @default(true)
  isPublic                 Boolean        @default(false)
  shareToken               String?        @unique
  shareCount               Int            @default(0)
  allowMultipleSubmissions Boolean        @default(true)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  creatorId                String
  activityId               String?
  comments                 Comment[]
  responses                FormResponse[]
  shares                   FormShare[]
  activity                 Activity?      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  creator                  User           @relation(fields: [creatorId], references: [id])

  @@map("forms")
}

model FormShare {
  id             String    @id @default(cuid())
  shareType      ShareType
  shareToken     String?   @unique
  canCollect     Boolean   @default(true)
  canExport      Boolean   @default(false)
  maxSubmissions Int?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  lastAccessed   DateTime?
  formId         String
  sharedWithId   String?
  createdById    String
  createdBy      User      @relation("FormShareCreator", fields: [createdById], references: [id])
  form           Form      @relation(fields: [formId], references: [id], onDelete: Cascade)
  sharedWith     User?     @relation("FormShareReceiver", fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@map("form_shares")
}

model FormResponse {
  id            String          @id @default(cuid())
  data          Json
  submittedAt   DateTime        @default(now())
  isOffline     Boolean         @default(false)
  syncedAt      DateTime?
  collectorType CollectorType   @default(USER)
  collectorInfo Json?
  formId        String
  respondentId  String?
  form          Form            @relation(fields: [formId], references: [id], onDelete: Cascade)
  respondent    User?           @relation(fields: [respondentId], references: [id])
  photos        ResponsePhoto[]

  @@map("form_responses")
}

model ResponsePhoto {
  id           String       @id @default(cuid())
  filename     String
  originalName String?
  filepath     String
  mimeType     String
  size         BigInt
  width        Int?
  height       Int?
  fieldId      String
  caption      String?
  latitude     Float?
  longitude    Float?
  takenAt      DateTime     @default(now())
  uploadedAt   DateTime     @default(now())
  responseId   String
  response     FormResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@map("response_photos")
}

model OfflineSync {
  id        String     @id @default(cuid())
  formId    String
  deviceId  String
  data      Json
  status    SyncStatus
  attempts  Int        @default(0)
  error     String?
  createdAt DateTime   @default(now())
  syncedAt  DateTime?

  @@map("offline_sync")
}

model Training {
  id              String                @id @default(cuid())
  title           String
  description     String?
  type            TrainingType
  location        String?
  startDate       DateTime
  endDate         DateTime?
  duration        Int?
  objectives      String[]
  maxParticipants Int?
  isInternal      Boolean               @default(true)
  organizer       String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  activityId      String?
  beneficiaries   String[]              @default([])
  diplomaObtained String?
  level           String?
  period          String?
  specialty       String?
  studentName     String?
  documents       Document[]
  participants    TrainingParticipant[]
  activity        Activity?             @relation(fields: [activityId], references: [id])

  @@map("trainings")
}

model TrainingParticipant {
  id           String    @id @default(cuid())
  role         String
  registeredAt DateTime  @default(now())
  attendedAt   DateTime?
  certificate  Boolean   @default(false)
  evaluation   Float?
  trainingId   String
  userId       String
  training     Training  @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingId, userId])
  @@map("training_participants")
}

model Internship {
  id           String     @id @default(cuid())
  title        String
  description  String?
  institution  String
  startDate    DateTime
  endDate      DateTime
  objectives   String[]
  results      String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  activityId   String?
  supervisorId String
  internId     String
  documents    Document[]
  activity     Activity?  @relation(fields: [activityId], references: [id])
  intern       User       @relation("InternshipIntern", fields: [internId], references: [id])
  supervisor   User       @relation("InternshipSupervisor", fields: [supervisorId], references: [id])

  @@map("internships")
}

model Supervision {
  id           String     @id @default(cuid())
  title        String
  type         String
  university   String
  startDate    DateTime
  endDate      DateTime?
  status       String
  abstract     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  activityId   String?
  supervisorId String
  studentId    String
  documents    Document[]
  activity     Activity?  @relation(fields: [activityId], references: [id])
  student      User       @relation("SupervisionStudent", fields: [studentId], references: [id])
  supervisor   User       @relation("SupervisionSupervisor", fields: [supervisorId], references: [id])

  @@map("supervisions")
}

model KnowledgeTransfer {
  id             String       @id @default(cuid())
  title          String
  description    String?
  type           TransferType
  targetAudience String[]
  location       String?
  date           DateTime
  participants   Int?
  impact         String?
  feedback       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  activityId     String?
  organizerId    String
  documents      Document[]
  activity       Activity?    @relation(fields: [activityId], references: [id])
  organizer      User         @relation(fields: [organizerId], references: [id])

  @@map("knowledge_transfers")
}

model CalendarEvent {
  id             String             @id @default(cuid())
  title          String
  description    String?
  type           EventType
  status         EventStatus        @default(PLANIFIE)
  startDate      DateTime
  endDate        DateTime?
  location       String?
  isAllDay       Boolean            @default(false)
  isRecurring    Boolean            @default(false)
  recurrenceRule String?
  color          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  creatorId      String
  stationId      String?
  projectId      String?
  activityId     String?
  activity       Activity?          @relation(fields: [activityId], references: [id])
  creator        User               @relation("EventCreator", fields: [creatorId], references: [id])
  project        Project?           @relation(fields: [projectId], references: [id])
  station        ResearchStation?   @relation(fields: [stationId], references: [id])
  documents      Document[]
  participants   EventParticipant[]
  seminar        Seminar?

  @@map("calendar_events")
}

model EventParticipant {
  id            String        @id @default(cuid())
  status        String        @default("INVITED")
  invitedAt     DateTime      @default(now())
  respondedAt   DateTime?
  eventId       String
  participantId String
  event         CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participant   User          @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([eventId, participantId])
  @@map("event_participants")
}

model Seminar {
  id              String               @id @default(cuid())
  title           String
  description     String?
  location        String?
  startDate       DateTime
  endDate         DateTime?
  status          SeminarStatus        @default(PLANIFIE)
  agenda          String?
  maxParticipants Int?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  organizerId     String
  calendarEventId String?              @unique
  documents       Document[]
  participants    SeminarParticipant[]
  calendarEvent   CalendarEvent?       @relation(fields: [calendarEventId], references: [id])
  organizer       User                 @relation("SeminarOrganizer", fields: [organizerId], references: [id])

  @@map("seminars")
}

model SeminarParticipant {
  id            String    @id @default(cuid())
  registeredAt  DateTime  @default(now())
  attendedAt    DateTime?
  seminarId     String
  participantId String
  participant   User      @relation(fields: [participantId], references: [id], onDelete: Cascade)
  seminar       Seminar   @relation(fields: [seminarId], references: [id], onDelete: Cascade)

  @@unique([seminarId, participantId])
  @@map("seminar_participants")
}

model Comment {
  id         String    @id @default(cuid())
  content    String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  authorId   String
  projectId  String?
  activityId String?
  taskId     String?
  formId     String?
  activity   Activity? @relation(fields: [activityId], references: [id], onDelete: Cascade)
  author     User      @relation(fields: [authorId], references: [id])
  form       Form?     @relation(fields: [formId], references: [id], onDelete: Cascade)
  project    Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task       Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Channel {
  id          String          @id @default(cuid())
  name        String
  description String?
  type        ChannelType     @default(GENERAL)
  isPrivate   Boolean         @default(false)
  isArchived  Boolean         @default(false)
  icon        String?
  color       String?
  projectId   String?
  themeId     String?
  creatorId   String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  members     ChannelMember[]
  creator     User            @relation("ChannelCreator", fields: [creatorId], references: [id])
  project     Project?        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  theme       ResearchTheme?  @relation(fields: [themeId], references: [id])
  messages    ChatMessage[]

  @@index([type])
  @@index([isArchived])
  @@index([projectId])
  @@index([themeId])
  @@map("channels")
}

model ChannelMember {
  id                   String            @id @default(cuid())
  role                 ChannelMemberRole @default(MEMBER)
  isMuted              Boolean           @default(false)
  lastReadAt           DateTime?
  lastReadMessageId    String?
  notificationsEnabled Boolean           @default(true)
  channelId            String
  userId               String
  joinedAt             DateTime          @default(now())
  leftAt               DateTime?
  channel              Channel           @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([userId])
  @@index([channelId])
  @@map("channel_members")
}

model ChatMessage {
  id              String            @id @default(cuid())
  content         String
  type            MessageType       @default(TEXT)
  isEdited        Boolean           @default(false)
  editedAt        DateTime?
  isDeleted       Boolean           @default(false)
  deletedAt       DateTime?
  deletedBy       String?
  fileUrl         String?
  fileName        String?
  fileSize        BigInt?
  fileMimeType    String?
  metadata        Json?
  authorId        String
  channelId       String
  parentMessageId String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  author          User              @relation("MessageAuthor", fields: [authorId], references: [id])
  channel         Channel           @relation(fields: [channelId], references: [id], onDelete: Cascade)
  parentMessage   ChatMessage?      @relation("MessageReplies", fields: [parentMessageId], references: [id], onDelete: Cascade)
  replies         ChatMessage[]     @relation("MessageReplies")
  mentions        MessageMention[]
  reactions       MessageReaction[]

  @@index([channelId])
  @@index([authorId])
  @@index([createdAt(sort: Desc)])
  @@index([parentMessageId])
  @@index([isDeleted])
  @@map("chat_messages")
}

model MessageReaction {
  id        String      @id @default(cuid())
  emoji     String
  messageId String
  userId    String
  createdAt DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("message_reactions")
}

model MessageMention {
  id        String      @id @default(cuid())
  messageId String
  userId    String
  createdAt DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@map("message_mentions")
}

model Notification {
  id         String    @id @default(cuid())
  title      String
  message    String
  type       String
  isRead     Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  readAt     DateTime?
  actionUrl  String?
  senderId   String?
  receiverId String
  entityType String?
  entityId   String?
  receiver   User      @relation("NotificationReceiver", fields: [receiverId], references: [id])
  sender     User?     @relation("NotificationSender", fields: [senderId], references: [id])

  @@map("notifications")
}

model AuditLog {
  id         String     @id @default(cuid())
  action     String
  level      AuditLevel @default(INFO)
  userId     String?
  entityType String?
  entityId   String?
  details    Json?
  metadata   Json?
  changes    Json?
  createdAt  DateTime   @default(now())
  user       User?      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([action])
  @@index([level])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

enum UserRole {
  CHERCHEUR
  COORDONATEUR_PROJET
  ADMINISTRATEUR
}

enum ProjectStatus {
  PLANIFIE
  EN_COURS
  SUSPENDU
  TERMINE
  ARCHIVE
}

enum ActivityType {
  RECHERCHE_EXPERIMENTALE
  RECHERCHE_DEVELOPPEMENT
  PRODUCTION_SEMENCES
  FORMATION_DISPENSEE
  FORMATION_RECUE
  STAGE
  ENCADREMENT
  TRANSFERT_ACQUIS
  SEMINAIRE
  ATELIER
  CONFERENCE
  DEMONSTRATION
  AUTRE
}

enum ActivityStatus {
  PLANIFIEE
  EN_COURS
  SUSPENDUE
  ANNULEE
  RECONDUITE
  CLOTUREE
}

enum ActivityLifecycleStatus {
  NOUVELLE
  RECONDUITE
  CLOTUREE
}

enum TaskStatus {
  A_FAIRE
  EN_COURS
  EN_REVISION
  TERMINEE
  ANNULEE
}

enum TaskPriority {
  BASSE
  NORMALE
  HAUTE
  URGENTE
}

enum DocumentType {
  RAPPORT
  FICHE_ACTIVITE
  FICHE_TECHNIQUE
  FICHE_INDIVIDUELLE
  DONNEES_EXPERIMENTALES
  FORMULAIRE
  PUBLICATION_SCIENTIFIQUE
  MEMOIRE
  THESE
  IMAGE
  PRESENTATION
  AUTRE
}

enum SeminarStatus {
  PLANIFIE
  EN_COURS
  TERMINE
  ANNULE
}

enum TrainingType {
  FORMATION_COURTE
  FORMATION_DIPLOMANTE
  STAGE_ADAPTATION
  STAGE_RECHERCHE
  ATELIER_TECHNIQUE
  SEMINAIRE_FORMATION
}

enum TransferType {
  FICHE_TECHNIQUE
  DEMONSTRATION
  FORMATION_PRODUCTEUR
  VISITE_GUIDEE
  EMISSION_RADIO
  REPORTAGE_TV
  PUBLICATION_VULGARISATION
  SITE_WEB
  RESEAUX_SOCIAUX
}

enum EventType {
  REUNION
  SEMINAIRE
  FORMATION
  MISSION_TERRAIN
  CONFERENCE
  ATELIER
  DEMONSTRATION
  VISITE
  SOUTENANCE
  AUTRE
}

enum EventStatus {
  PLANIFIE
  EN_COURS
  TERMINE
  ANNULE
  REPORTE
}

enum AuditLevel {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum ParticipantRole {
  RESPONSABLE
  CO_RESPONSABLE
  CHERCHEUR_PRINCIPAL
  CHERCHEUR_ASSOCIE
  TECHNICIEN
  STAGIAIRE
  PARTENAIRE_EXTERNE
  CONSULTANT
}

enum FundingType {
  SUBVENTION
  CONTRAT
  PARTENARIAT
  BUDGET_INTERNE
  COOPERATION_INTERNATIONALE
  SECTEUR_PRIVE
}

enum FundingStatus {
  DEMANDE
  APPROUVE
  REJETE
  EN_COURS
  TERMINE
  SUSPENDU
}

enum PartnerType {
  UNIVERSITE
  INSTITUT_RECHERCHE
  ENTREPRISE_PRIVEE
  ONG
  ORGANISME_PUBLIC
  ORGANISATION_INTERNATIONALE
  COOPERATIVE
  ASSOCIATION
}

enum ConventionStatus {
  EN_NEGOCIATION
  SIGNEE
  EN_COURS
  CLOTUREE
  SUSPENDUE
  RESILIEE
}

enum ConventionType {
  BILATERALE
  MULTILATERALE
  PARTENARIAT_PUBLIC_PRIVE
  COOPERATION_INTERNATIONALE
  SOUS_TRAITANCE
}

enum ShareType {
  INTERNAL
  EXTERNAL
}

enum CollectorType {
  USER
  SHARED_USER
  PUBLIC
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  ERROR
  RETRY
}

enum PublicationType {
  ARTICLE_SCIENTIFIQUE
  COMMUNICATION_CONFERENCE
  CHAPITRE_LIVRE
  LIVRE
  RAPPORT_TECHNIQUE
  FICHE_TECHNIQUE
  MEMOIRE
  THESE
}

enum ObjectiveStatus {
  EN_ATTENTE
  EN_COURS
  TERMINE
  ANNULE
  REPORTE
}

enum ChannelType {
  GENERAL
  PROJECT
  THEME
  PRIVATE
  ANNOUNCEMENT
}

enum ChannelMemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
}
